<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/mui.picker.min.css" />
		<!--<link rel="stylesheet" href="../css/mobile-select.css" />-->
		
		<!--<script src="../js/mobile-select.js"></script>-->
		<script src="../js/jquery-3.1.1.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<style>
			*{
				font-size: 16px;
				color: #666666;
				font-family: "微软雅黑";
				!important;
			}
			
			
			
			form{
				margin-top: 20px;
				
			}
		.mui-input-row{
		
			letter-spacing: 1px;
			/*background: darkcyan;*/
			display: flex;
			align-items: center;
			padding: 25px 0;
			
			
		}
		
		input{
		
			font-size: 16px;
			color: #666666;
			font-family: "微软雅黑";
			/*margin-top: 5px;*/
			background: darkgoldenrod;
		}
		
		.btnBox{
			 position: absolute;
	        bottom: 20px;
	        width: 100%;
	        height: 50px;
		}
		
		.btn1{
		
			 width: 95%;
          height: 50px;
          /*background: salmon;*/
          /*color: white;*/
          font-size: 16px;
          border-radius: 5px;
          display: block;       
          margin: 0 auto;
          /*margin-top: 180px;*/
          /*margin-bottom: 20px;*/
		}
		
		.mui-btn-blue{
			background-color:#e281c2;
			border-color: #e281c2;
		}
		</style>
	</head>

	<body>
		
		<script type="text/javascript">
			 mui.init({
			    beforeback: function(){
			        //获得列表界面的webview
			         var list = plus.webview.currentWebview().opener();//这种方式也可以
			         //目标页面
//			         var list = plus.webview.getWebviewById('homeSet.html');  
			         //触发列表界面的自定义事件（refresh）,从而进行数据刷新  
			         mui.fire(list, 'refresh');  
			        //返回true，继续页面关闭逻辑
			        return true;
			    }
			});

		</script>
		
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">编辑资料</h1>
		</header>
		
		<div  class="mui-content wrap">
		    <form class="mui-input-group">
			    <div id="userImg" class="mui-input-row" style="height: 60px;">
			        <label>宝宝头像：</label>
			      	<div class="touxiang" style="width: 50px; height: 50px;">		    			
		    			<img id="headimg" src="" style="width: 100%;height:100%;margin-left: 30px;" />
	    			</div>
			    </div>
			     <div class="mui-input-row">
			        <label>宝宝昵称：</label>
			        <input id="nikename" type="text" class="mui-input-clear">
			    </div>
			     <div data-options='{"type":"month"}' class="btn mui-input-row">
			        <!--<label>宝宝生日：</label>-->
			        <!--<input type="text" class="mui-input-clear" >-->
			        <!--<div id="trigger2"></div>-->
			        <button id='demo6' data-options='{"type":"month"}' class="btn mui-btn mui-btn-block" style="border: none;margin-top:10px;font-size: 16.5px;color: #666666;">选择月份：</button>
			        <div id='result' class="ui-alert" style="margin-left: 73px;"></div>
			    </div>
			     <div class="mui-input-row">
			        <label>宝宝性别：</label>
			        <span style="display: flex;align-items: center;">
			        	 <input id="nan" type="radio" name="sex" id="" value="1" />&nbsp&nbsp男
			        	 
			        </span>
			        
			       <span style="margin-left: 35px;display: flex;align-items: center;">
			       	 <input id="nv" type="radio" name="sex" id="" value="2" />&nbsp&nbsp女
			       </span>
			       
			       
			    </div>
			</form>
			
			<div class="btnBox">
				<button id="Confirm" type="button" class="mui-btn mui-btn-danger mui-btn-outlined btn1">确认保存</button>
			</div>
			
		</div>
	</body>

</html>
<script>		
	
	mui.ready(function(){
			
		mui.ajax({
			url:'http://www.internet-web.cn/User/UserInfo',
			type:'GET',
			
			data:{access_token:window.localStorage.getItem('access_token')},
			success:function(data){			
				data = JSON.parse(data);
//				alert(data);

				var UserId = data.data.UserId;
				var UserPhone = data.data.UserPhone;
				var UserAvatar = data.data.UserAvatar;
				var UserSex = data.data.UserSex;
				var NickName = data.data.NickName;
				var IsVip = data.data.IsVip;
				var Birth = data.data.Birth;
				
//				alert(UserSex);
//			
				document.getElementById('headimg').setAttribute('src',UserAvatar);
		
				document.getElementById('nikename').value = NickName;
				
				
				document.getElementById('result').innerText = Birth;
				

				if(UserSex==0){
					document.getElementById('sex').innerText = '未设置';
				
					
				}else if(UserSex==1){
						document.getElementById('nan').checked  = true;
					
				}else{
					
					document.getElementById('nv').checked  = true;
				}
					
			}
		});
	})

</script>

<script>
	(function($) {
		$.init();
		var result = $('#result')[0];
		var btns = $('.btn');
		btns.each(function(i, btn) {
			btn.addEventListener('tap', function() {
				var _self = this;
				if(_self.picker) {
					_self.picker.show(function (rs) {
						result.innerText =  rs.text;
						_self.picker.dispose();
						_self.picker = null;
					});
				} else {
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var id = this.getAttribute('id');
					/*
					 * 首次显示时实例化组件
					 * 示例为了简洁，将 options 放在了按钮的 dom 上
					 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
					 */
					_self.picker = new $.DtPicker(options);
					_self.picker.show(function(rs) {
						/*
						 * rs.value 拼合后的 value
						 * rs.text 拼合后的 text
						 * rs.y 年，可以通过 rs.y.vaue 和 rs.y.text 获取值和文本
						 * rs.m 月，用法同年
						 * rs.d 日，用法同年
						 * rs.h 时，用法同年
						 * rs.i 分（minutes 的第二个字母），用法同年
						 */
						result.innerText = rs.text;
						/* 
						 * 返回 false 可以阻止选择框的关闭
						 * return false;
						 */
						/*
						 * 释放组件资源，释放后将将不能再操作组件
						 * 通常情况下，不需要示放组件，new DtPicker(options) 后，可以一直使用。
						 * 当前示例，因为内容较多，如不进行资原释放，在某些设备上会较慢。
						 * 所以每次用完便立即调用 dispose 进行释放，下次用时再创建新实例。
						 */
						_self.picker.dispose();
						_self.picker = null;
					});
				}
				
			}, false);
		});
	})(mui);
</script>
	
<script type="text/javascript">
	
	$(function () {
    //探测手机屏幕宽度   并赋值给wrap
    // $('#wrap').height(document.body.clientHeight);
    // $('#wrap').height($(window).height());
    console.log(document.body.clientHeight);
//    检测小键盘的弹出    隐藏底部dom

    var winHeight = $(window).height();
    $('#wrap').height(winHeight);
    console.log(winHeight);
    $(window).resize(function(){
        var thisHeight=$(this).height();
        if(winHeight - thisHeight >50){
            //当软键盘弹出，在这里面操作

            $('#Confirm').hide();
        }else{
            //当软键盘收起，在此处操作
            $('#Confirm').show();
        }
    });
});
	

</script>

   <script>  
    function plusReady(){  
        mui("body").on("tap","#userImg",function(){  
            page.imgUp();  
        })  
    }  
    
    //修改用户信息
//  var ajxurl = "http://www.internet-web.cn/User/UserInfoUpdate";
//  function test(){
//  
//       mui.post(ajxurl,{access_token:'jLCRNvVAnKo8QXdENCjtoExMDDo',nickname:,sex:'1',birth:'2018-01-01',head:uploadurl},function(data){
//       	mui.alert('修改成功')
//       },'json');
//
//  }
    
    
    var page=null;  
    page=
    {
        imgUp:function()
        {
            var m=this;  
            plus.nativeUI.actionSheet({cancel:"取消",
            buttons:[
                {title:"拍照"},  
                {title:"从相册中选择"}  
            ]}, 
            function(e){//1 是拍照  2 从相册中选择
                switch(e.index){  
                    case 1:appendByCamera();break;  
                    case 2:appendByGallery();break;  
                }  
            });  
        }  
    }  
    //1.拍照添加文件
    function appendByCamera(){
        plus.camera.getCamera().captureImage(function(e){
            console.log(e);
            plus.io.resolveLocalFileSystemURL(e, function(entry) { 
            var path = entry.toLocalURL(); 
            document.getElementById("headimg").src = path; 
            }, function(e) { 
                mui.toast("读取拍照文件错误：" + e.message); 
            }); 
        });    
    }
    //2.从相册添加文件
    function appendByGallery(){
        plus.gallery.pick(function(path){
            document.getElementById("headimg").src = path; 
        });
    }
    
    //服务端接口路径
    var server = "http://www.internet-web.cn/media/upload";
    //获取图片元素
    var files = document.getElementById('headimg');
    var uploadurl="";
    // 上传文件
    function upload()
    {
        console.log(files.src);
        var wt=plus.nativeUI.showWaiting();
        var task=plus.uploader.createUpload
        (server,{method:"POST"},
            function(t,status){ 
                if(status==200){
                	var code = JSON.parse(t.responseText).errcode;
//                	   mui.alert(code);
//                	   mui.alert(t.responseText.data);
                  	   if(code == '41008'){
                  	  var  	ddd='';
                  	  
//                	   	 mui.alert(1111);
                  	   	   var ajxurl2 = "http://www.internet-web.cn/User/UserInfoUpdate";
                  	   	 mui.post(ajxurl2,{access_token:window.localStorage.getItem('access_token'),nickname:nikename,sex:sex,birth:birth1,head:ddd},function(data){
		                 	mui.toast('修改成功')
		                 	mui.back();
		                 },'json');
                  	   }else{
                  	   	
                  	   	uploadurl=JSON.parse(t.responseText).data[0];
                  	   	    //修改用户信息
		            var ajxurl = "http://www.internet-web.cn/User/UserInfoUpdate";
//		            mui.alert(uploadurl);
		                setTimeout(function(){
		                	
		                 mui.post(ajxurl,{access_token:window.localStorage.getItem('access_token'),nickname:nikename,sex:sex,birth:birth1,head:uploadurl},function(data){
		                 	mui.toast('修改成功')
		                 	mui.back();
		                 },'json');
		                },500);
		                 
                  	   }
                	
                	
                 
             
		
		         	
                    wt.close(); //关闭等待提示按钮
                }else{
                    alert("上传失败："+status);
                    wt.close();//关闭等待提示按钮
                }
            }
        );
        //添加其他参数
        task.addData("access_token",window.localStorage.getItem('access_token'));
        task.addFile(files.src,{key:"dddd"});
        task.start();
    }  
    if(window.plus){  
        plusReady();  
    }else{  
        document.addEventListener("plusready",plusReady,false);  
    }       
    
	

</script> 
<script>
	    var time = 0; 
  document.getElementById('Confirm').addEventListener('tap',function(){
//	alert($('#result').text().length)
  	//				alert($('input[name="sex"]:checked ').val());
		if($('#nikename').val()==''||$('input[name="sex"]:checked ').val()=='undefined'||$('#result').text().length!=7){
			   mui.alert('填写完成才能提交哦...', '温馨提示', function() {
//                  info.innerText = '你刚关闭了警告框';


                },'div');
		}else{
			
			 nikename  =$('#nikename').val();
			
			 sex  =  $('input[name="sex"]:checked ').val();
			
			var birth = $('#result').text()+'-01';
			
			 birth1 = birth.trim();
			
//			alert(birth1);
		
			upload();	
			
		
			    var access_token = window.localStorage.getItem('access_token');
			
//					alert(access_token);
			
//		   mui.ajax({
//				
//				url:'http://www.internet-web.cn/User/UserInfoUpdate',
//				type:'POST',
//				async:false,
//				data:{
//					access_token:'jLCRNvVAnKo8QXdENCjtoExMDDo',
//					nickname:nikename,
//					sex:sex,
//					birth:birth,
//					head:uploadurl
//				},
//				success:function(data){
//					mui.toast('保存成功！');
//				}
//			});
			
		
			

		}
		
})
</script>